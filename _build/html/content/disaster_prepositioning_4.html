
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Production Code &#8212; Disaster Prepositioning Case Study</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=2b93f807" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/disaster_prepositioning_4';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Wrapping It Up" href="disaster_prepositioning_5.html" />
    <link rel="prev" title="3.B More On Expected Value" href="disaster_prepositioning_3_B.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Disaster Prepositioning Case Study</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to ESUPS Case Study
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="disaster_prepositioning_0.html">Enhancing Humanitarian Response with ESUPS and the STOCKHOLM Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="disaster_prepositioning_1.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="disaster_prepositioning_2.html">The Setup</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="disaster_prepositioning_3.html">Optimizing!</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="disaster_prepositioning_3_A.html">2.A Introduction to Modeling Optimization Problems</a></li>


<li class="toctree-l2"><a class="reference internal" href="disaster_prepositioning_3_B.html">3.B More On Expected Value</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Production Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="disaster_prepositioning_5.html">Wrapping It Up</a></li>

</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/content/disaster_prepositioning_4.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Production Code</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-reader-and-class">Data Reader and Class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis">Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#geting-it-ready-for-optimization">Geting it ready for Optimization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solver">Solver</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#runing-it-all">Runing it All</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="production-code">
<h1>Production Code<a class="headerlink" href="#production-code" title="Link to this heading">#</a></h1>
<p>When converting our code snippets into production-level code, we have a few goals,</p>
<ol class="arabic simple">
<li><p><strong>Readability</strong>:	Our code should be easy to understand and follow, even for someone who didn’t write it. Clear naming conventions, well-structured functions, and comments where necessary help ensure that others can read and maintain the code effectively.</p></li>
<li><p><strong>Robustness</strong>: The code needs to handle different edge cases and potential errors gracefully, without breaking. This means writing code that checks for invalid inputs, unexpected conditions, and includes error handling to keep the program running smoothly.</p></li>
<li><p><strong>Testing</strong>: Code should be tested thoroughly to ensure it works as expected in various scenarios. This involves writing test cases that cover different functionalities, both common and rare, to catch bugs early and maintain confidence in the code’s reliability.</p></li>
</ol>
<p>To achieve these goals, we need a solid design approach that provides structure and flexibility to our code. This is where Object-Oriented Programming (OOP) comes in. It’s one of the most popular frameworks, and you’ve likely worked with it in class or otherwise. OOP offers a way to organize code into logical units that make it easier to read, robust, and testable. By structuring our code around objects that encapsulate data and functionality, we create a modular framework that simplifies complex data operations and supports future growth.</p>
<p>OOP promotes modularity, reusability, and maintainability, allowing for a clearer separation of concerns and reducing the likelihood of errors. Additionally, OOP’s use of abstraction and inheritance helps create reusable components, ensuring consistent and efficient code across all parts of the project. So, what does this all actually look like in practice?</p>
<p>Let’s start with a general flow diagram</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flowchart</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">flowchart</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;flowchart&#39; is not defined
</pre></div>
</div>
</div>
</div>
<section id="data-reader-and-class">
<h2>Data Reader and Class<a class="headerlink" href="#data-reader-and-class" title="Link to this heading">#</a></h2>
<p>The first stage in the process is obviously cleaning and processing the data, and one of the interesting things that you may not have seen in course-work is the segmentation of the data reader class and the dataset class. Often in smaller projects, the reader functionality is added as a class method, many times within the instantiation call, which can make intuitive sense. However, there are a few key benefits to separating them out when we work with larger projects.</p>
<ol class="arabic simple">
<li><p>Separation of Concerns: By creating separate classes, each class is responsible for a distinct function — the data reader class handles the loading and preprocessing of data from various sources, while the dataset class manages how the data is stored, accessed, and manipulated. This separation makes the codebase easier to understand and modify, as changes to how data is read do not impact how the data is organized or utilized downstream.</p></li>
<li><p>Reusability: When data reading and data management are isolated into their own classes, they can be reused across different projects or tasks without modification. For instance, the same data reader class can be employed to load data from multiple sources (like CSVs, databases, or APIs) while reusing the dataset class to provide a uniform interface for accessing and manipulating data, regardless of its origin.</p></li>
<li><p>Maintainability: Segmenting these responsibilities simplifies debugging and testing. If there is an issue with data loading, the problem is likely within the data reader class, whereas issues with data handling can be traced back to the dataset class. This modularity reduces the risk of unintended side effects when making changes or improvements, since each class operates independently.</p></li>
<li><p>Flexibility: A segmented approach allows developers to quickly adapt to changes in data sources or formats without needing to rewrite core data handling logic. The data reader class can be updated to handle new data formats or sources, while the dataset class remains consistent in providing a structured interface for data access and manipulation.</p></li>
<li><p>Testability: Perhaps one of the largest advantages is a layout that more easily lends itself to testing. If someone manually creates a test set, either class can be tested regardless of the other’s state, and where the errors lie is often much easier to figure out</p></li>
</ol>
<p>As you’ll come to see, one of the core principles used to develop large projects like this is similar to the idea of a black box from machine learning. With multiple people working together, there is an emphasis on smoothly integrating everyone’s work. So this approach can allow a potentially difficult task (loading and preparing the data) to be distributed among developers without requiring everyone to understand all the intricacies of each class</p>
<p>Let’s see how this has been implemented!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Country</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">continent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Location</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">address</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">country</span><span class="p">:</span> <span class="n">Country</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">latitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">longitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DisasterType</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DisasterImpact</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">disaster</span><span class="p">:</span> <span class="s2">&quot;Disaster&quot;</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">location</span><span class="p">:</span> <span class="s2">&quot;DisasterLocation&quot;</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sub_location_nr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">total_affected</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DisasterLocation</span><span class="p">(</span><span class="n">Location</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Disaster</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">DisasterType</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">day</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">month</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">impacted_locations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DisasterImpact</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Depot</span><span class="p">(</span><span class="n">Location</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Item</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Metric tons</span>
    <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Cubic metres</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TransportMode</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">distance_method</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">big_m_cost_elim</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">max_driving_time_cut_above_hrs</span><span class="p">:</span> <span class="nb">float</span>


<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DistanceInfo</span><span class="p">:</span>
    <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Kilometres</span>
    <span class="n">time</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Hours</span>
    <span class="n">cost_per_ton</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># USD</span>

<span class="n">DistanceMatrix</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Location</span><span class="p">,</span> <span class="n">Location</span><span class="p">,</span> <span class="n">TransportMode</span><span class="p">],</span> <span class="n">DistanceInfo</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>The Dataset class encapsulates all data required for the analysis and optimization tasks. It includes lists of depots, disasters, and disaster_locations, and dictionaries for probabilities of disasters, inventory levels, and other critical data. The _zero_demand_threshold is a constant used internally to determine when demand should be considered negligible.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Dataset</span><span class="p">:</span>
    <span class="n">depots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Depot</span><span class="p">]</span>
    <span class="n">disasters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Disaster</span><span class="p">]</span>
    <span class="n">disaster_locations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DisasterLocation</span><span class="p">]</span>
    <span class="n">probabilities</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Disaster</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">items</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Item</span><span class="p">]</span>
    <span class="n">transport_modes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TransportMode</span><span class="p">]</span>
    <span class="n">inventory</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Depot</span><span class="p">,</span> <span class="n">Item</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">inventory_scenarios</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Depot</span><span class="p">,</span> <span class="n">Item</span><span class="p">],</span> <span class="nb">int</span><span class="p">]]</span>
    <span class="n">distance</span><span class="p">:</span> <span class="n">DistanceMatrix</span>
    <span class="n">people_affected</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DisasterImpact</span><span class="p">,</span> <span class="n">Item</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">persons_per_item_general</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DisasterImpact</span><span class="p">,</span> <span class="n">Item</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">persons_per_item_monthly</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DisasterImpact</span><span class="p">,</span> <span class="n">Item</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">disaster_affected_totals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>

    <span class="n">_zero_demand_threshold</span> <span class="o">=</span> <span class="mf">1e6</span>


<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The take_disaster_subset method allows us to focus our analysis on a specific </span>
<span class="sd">    subset of disasters by providing a predicate function that filters disasters </span>
<span class="sd">    based on certain criteria (e.g., date range, disaster type). It recalculates </span>
<span class="sd">    probabilities to ensure they sum up to 1 after filtering. Related data such as </span>
<span class="sd">    locations, distances, and affected populations are also filtered to maintain </span>
<span class="sd">    consistency. If no filtering occurs (i.e., all disasters are included), the method </span>
<span class="sd">    returns the original dataset to avoid unnecessary duplication.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">take_disaster_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicate</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Disaster</span><span class="p">],</span> <span class="nb">bool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a smaller dataset by only selecting a subset of the disasters with corresponding data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">disasters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">disasters</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">disasters</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disasters</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">total_probability</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probabilities</span><span class="p">[</span><span class="n">disaster</span><span class="p">]</span> <span class="k">for</span> <span class="n">disaster</span> <span class="ow">in</span> <span class="n">disasters</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">disaster</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">probabilities</span><span class="p">[</span><span class="n">disaster</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_probability</span>
            <span class="k">for</span> <span class="n">disaster</span> <span class="ow">in</span> <span class="n">disasters</span>
        <span class="p">}</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">impact</span><span class="o">.</span><span class="n">location</span>
            <span class="k">for</span> <span class="n">disaster</span> <span class="ow">in</span> <span class="n">disasters</span>
            <span class="k">for</span> <span class="n">impact</span> <span class="ow">in</span> <span class="n">disaster</span><span class="o">.</span><span class="n">impacted_locations</span>
        <span class="p">]</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span> <span class="n">cell</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">mode</span><span class="p">),</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">destination</span> <span class="ow">in</span> <span class="n">locations</span>
        <span class="p">}</span>
        <span class="n">people_affected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="n">value</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">people_affected</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">locations</span>
        <span class="p">}</span>
        <span class="n">persons_per_item_general</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="n">value</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">persons_per_item_general</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">locations</span>
        <span class="p">}</span>
        <span class="n">persons_per_item_monthly</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="n">value</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">persons_per_item_monthly</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">locations</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">Dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depots</span><span class="p">,</span>
            <span class="n">disasters</span><span class="p">,</span>
            <span class="n">locations</span><span class="p">,</span>
            <span class="n">probabilities</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport_modes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inventory_scenarios</span><span class="p">,</span>
            <span class="n">distance</span><span class="p">,</span>
            <span class="n">people_affected</span><span class="p">,</span>
            <span class="n">persons_per_item_general</span><span class="p">,</span>
            <span class="n">persons_per_item_monthly</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disaster_affected_totals</span><span class="p">,</span>
        <span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The take_inventory_scenario method enables us to switch between different </span>
<span class="sd">    inventory configurations stored in inventory_scenarios. By specifying a filename </span>
<span class="sd">    key, we retrieve the corresponding inventory data. If the requested inventory </span>
<span class="sd">    is already in use, the method returns the current dataset. Otherwise, it creates </span>
<span class="sd">    a new Dataset instance with the updated inventory, facilitating comparative </span>
<span class="sd">    analysis of different supply scenarios.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">take_inventory_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_scenarios</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Inventory scenario not found&quot;</span><span class="p">)</span>
        <span class="n">inventory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_scenarios</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">inventory</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">Dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depots</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disasters</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disaster_locations</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">probabilities</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport_modes</span><span class="p">,</span>
            <span class="n">inventory</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inventory_scenarios</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">people_affected</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">persons_per_item_general</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">persons_per_item_monthly</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disaster_affected_totals</span><span class="p">,</span>
        <span class="p">)</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The general_demand property calculates the overall demand for each </span>
<span class="sd">    item at each impacted location using general beta values </span>
<span class="sd">    (persons_per_item_general). The beta value represents how many people </span>
<span class="sd">    can be served per item. We utilize the _calc_items_needed helper method </span>
<span class="sd">    for calculations. The @functools.cached_property decorator ensures that </span>
<span class="sd">    the result is computed once and cached, improving performance for repeated </span>
<span class="sd">    access.</span>

<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">general_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DisasterImpact</span><span class="p">,</span> <span class="n">Item</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">general_demand</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_items_needed</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">people_affected</span><span class="p">[</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">persons_per_item_general</span><span class="p">[</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">disaster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">disasters</span>
            <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">disaster</span><span class="o">.</span><span class="n">impacted_locations</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">general_demand</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mf">1e-1</span><span class="p">}</span>


<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Similarly, the monthly_demand property calculates demand on a monthly </span>
<span class="sd">    basis using persons_per_item_monthly. This allows us to capture time-sensitive </span>
<span class="sd">    demand variations, which are crucial in disaster response. The result is </span>
<span class="sd">    cached, and we filter out values below 1e-3 to maintain computational efficiency.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">monthly_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DisasterImpact</span><span class="p">,</span> <span class="n">Item</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">monthly_demand</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_items_needed</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">people_affected</span><span class="p">[</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">persons_per_item_monthly</span><span class="p">[</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">disaster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">disasters</span>
            <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">disaster</span><span class="o">.</span><span class="n">impacted_locations</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">monthly_demand</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">}</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The _calc_items_needed helper method computes the number of items required </span>
<span class="sd">    based on the number of people affected and the beta value. If beta is zero or </span>
<span class="sd">    exceeds a predefined threshold (_zero_demand_threshold), indicating negligible </span>
<span class="sd">    demand, the method returns zero. Otherwise, it divides people_affected by beta </span>
<span class="sd">    to determine the required items. This calculation is fundamental for planning supply </span>
<span class="sd">    quantities in logistics.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calc_items_needed</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">people_affected</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">beta</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">beta</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zero_demand_threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">people_affected</span> <span class="o">/</span> <span class="n">beta</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="analysis">
<h2>Analysis<a class="headerlink" href="#analysis" title="Link to this heading">#</a></h2>
<p>If you recall from section 2.6, to solve for optimal allocations we have to consider several independent items, which requires solving the model for each version. This can get messy pretty quickly considering the complexity of the model and the dataset that it uses. So in the actual implementation, the developers created a class to handle this larger loop. It will set up the problem for a specific context, and then call a dedicated solver class.</p>
<p>While we won’t go into it here, this set up also lends itself nicely to leveraging multithreading. You’ll notice that there is a sub-class in the code which creates “workers”. These allow use to handle each problem independently and is a common set-up in python for multi-threading. Luckily for our sakes, the problem overall is fast enough to be solved on a single instance, so this hasn’t been implemented fully in production code!</p>
<p>So let’s take a look at how it all comes together.</p>
<p>Firsr we’ll define our name space and methods used from the data reader class:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntEnum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">getenv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">Disaster</span><span class="p">,</span> <span class="n">DisasterImpact</span><span class="p">,</span> <span class="n">DistanceInfo</span><span class="p">,</span> <span class="n">Item</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.solving</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AllocationStrategy</span><span class="p">,</span>
    <span class="n">CostMatrix</span><span class="p">,</span>
    <span class="n">Problem</span><span class="p">,</span>
    <span class="n">Solution</span><span class="p">,</span>
    <span class="n">SolverParameters</span><span class="p">,</span>
    <span class="n">StochasticSolver</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SolverObjective</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">Cost</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
    <span class="n">Time</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
    <span class="n">Distance</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">SolutionTags</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">SolverObjective</span><span class="p">,</span> <span class="n">AllocationStrategy</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now we’ll get into the meat of it:</p>
<p>Here, AnalysisParameters is a configuration class that holds various parameters influencing the analysis process. These settings allow us to control aspects like which disasters to consider, the objectives to optimize for, and how to handle inventory and demand.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AnalysisParameters</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    expand_depot_set</span>
<span class="sd">        Flag indicating whether inventory can be reallocated to depots that don&#39;t currently hold any stock</span>
<span class="sd">    care_about_month_demand</span>
<span class="sd">        Flag indicating whether we take month-by-month demand (True) or the general number (False)</span>
<span class="sd">    disaster_month</span>
<span class="sd">        Month from which to select disasters</span>
<span class="sd">    num_months_to_average</span>
<span class="sd">        Number of months to use for selecting disasters, when disasterMonth&gt;=0</span>
<span class="sd">    optimization_objectives</span>
<span class="sd">        Set of objectives to use for running the optimization model</span>
<span class="sd">    comparison_objectives</span>
<span class="sd">        Set of objectives to use for comparing results</span>
<span class="sd">    allocation_strategies</span>
<span class="sd">        Which strategies to test for (re)allocation inventory to depots in the first stage</span>
<span class="sd">    min_year</span>
<span class="sd">        First year from which disasters should be taken into account</span>
<span class="sd">    max_year</span>
<span class="sd">        Last year from which disasters should be taken into account</span>
<span class="sd">    scale_demand</span>
<span class="sd">        Whether demand must be scaled to not exceed total available inventory or not</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">expand_depot_set</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">care_about_month_demand</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">disaster_month</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">num_months_to_average</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">optimization_objectives</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SolverObjective</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">SolverObjective</span><span class="o">.</span><span class="n">Cost</span><span class="p">,</span>
        <span class="n">SolverObjective</span><span class="o">.</span><span class="n">Time</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">comparison_objectives</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SolverObjective</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">SolverObjective</span><span class="p">)</span>
    <span class="n">allocation_strategies</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">AllocationStrategy</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">AllocationStrategy</span><span class="p">)</span>
    <span class="n">min_year</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1900</span>
    <span class="n">max_year</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2100</span>
    <span class="n">scale_demand</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<p>The Analysis class encapsulates all results and statistics from the optimization runs. It includes solutions for different objectives and strategies, along with computed metrics that help in evaluating and comparing these solutions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analysis results for multiple optimization runs for a single dataset and item, using different objectives and allocation strategies.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    parameters:</span>
<span class="sd">        Parameters used to construct the analysis</span>
<span class="sd">    dataset:</span>
<span class="sd">        Original dataset being analyzed</span>
<span class="sd">    item:</span>
<span class="sd">        Item for which the analysis was performed</span>
<span class="sd">    solutions:</span>
<span class="sd">        Dictionary of solutions for all solved problems</span>
<span class="sd">    solution_stats</span>
<span class="sd">        Index: objective, strategy</span>
<span class="sd">        Columns:</span>
<span class="sd">        - coveredDemandExcDummy</span>
<span class="sd">        - dualTotInv</span>
<span class="sd">        - totalCostIncDummy</span>
<span class="sd">        - totalCostExcDummy</span>
<span class="sd">        - totalDemand</span>
<span class="sd">        - fractionOfDisastersUsingDummy</span>
<span class="sd">        - averageUnitCost</span>
<span class="sd">        - demandFulfillmentFraction</span>
<span class="sd">    balance_metric</span>
<span class="sd">        Index: objective</span>
<span class="sd">        Columns: balanceMetric</span>
<span class="sd">    units_shipped</span>
<span class="sd">        Index: objective, strategy, mode</span>
<span class="sd">        Columns: unitsShipped, unitsShippedWeighted</span>
<span class="sd">    people_served_per_item</span>
<span class="sd">        Index: objective, strategy</span>
<span class="sd">        Columns: peopleServedPerItem</span>
<span class="sd">    cross_ompact</span>
<span class="sd">        Index: objective, strategy, other</span>
<span class="sd">        Columns: impact</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parameters</span><span class="p">:</span> <span class="n">AnalysisParameters</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span>
    <span class="n">item</span><span class="p">:</span> <span class="n">Item</span>
    <span class="n">solutions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">SolutionTags</span><span class="p">,</span> <span class="n">Solution</span><span class="p">]</span>
    <span class="n">solution_stats</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">balance_metric</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">units_shipped</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">people_served_per_item</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">cross_impact</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">AnalysisParameters</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">,</span>
        <span class="n">solutions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">SolutionTags</span><span class="p">,</span> <span class="n">Solution</span><span class="p">],</span>
        <span class="n">solution_stats</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">balance_metric</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">units_shipped</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">people_served_per_item</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cross_impact</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solutions</span> <span class="o">=</span> <span class="n">solutions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_stats</span> <span class="o">=</span> <span class="n">solution_stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balance_metric</span> <span class="o">=</span> <span class="n">balance_metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units_shipped</span> <span class="o">=</span> <span class="n">units_shipped</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">people_served_per_item</span> <span class="o">=</span> <span class="n">people_served_per_item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_impact</span> <span class="o">=</span> <span class="n">cross_impact</span>
</pre></div>
</div>
</div>
</div>
<p>The AnalyzerWorker class performs the core computation. It runs optimization models for different objectives and strategies, processes the results, and computes various metrics for analysis. The _post_process method compiles these results into meaningful statistics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AnalyzerWorker</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">AnalysisParameters</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span> <span class="o">=</span> <span class="n">StochasticSolver</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Analysis</span><span class="p">:</span>
        <span class="c1">#a=len(str(dataset))</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="c1">#print(len(str(dataset))!=a)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">disaster</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">disasters</span><span class="p">)</span> <span class="k">for</span> <span class="n">disaster</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">disasters</span>
        <span class="p">}</span>

        <span class="n">solutions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">SolutionTags</span><span class="p">,</span> <span class="n">Solution</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Construct cost matrices once</span>
        <span class="n">cost_matrices</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">objective</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cost_matrix</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">objective</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">objective</span> <span class="ow">in</span> <span class="n">SolverObjective</span>
        <span class="p">}</span>

        <span class="c1"># Construct inventory</span>
        <span class="n">inventory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_inventory</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">inventory</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Construct demand</span>
        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_demand</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

        <span class="c1"># Solve models for all objectives and strategies</span>
        <span class="k">for</span> <span class="n">objective</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">optimization_objectives</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">allocation_strategies</span><span class="p">:</span>
                <span class="n">problem</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span>
                    <span class="n">dataset</span><span class="o">.</span><span class="n">depots</span><span class="p">,</span>
                    <span class="n">inventory</span><span class="p">,</span>
                    <span class="n">demand</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="o">.</span><span class="n">disasters</span><span class="p">,</span>
                    <span class="n">probabilities</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="o">.</span><span class="n">transport_modes</span><span class="p">,</span>
                    <span class="n">cost_matrices</span><span class="p">[</span><span class="n">objective</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">SolverParameters</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">scale_demand</span><span class="p">)</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
                <span class="n">solutions</span><span class="p">[</span><span class="n">tags</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_process</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">cost_matrices</span><span class="p">,</span> <span class="n">solutions</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solver</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_select_inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">depot</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">depot</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">depot</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">depots</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">expand_depot_set</span>
            <span class="ow">or</span> <span class="n">dataset</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">depot</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">disaster_month</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">months</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">disaster_month</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">disaster_month</span>
                <span class="o">+</span> <span class="mi">1</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">num_months_to_average</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">months</span> <span class="o">=</span> <span class="p">[(</span><span class="n">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months</span><span class="p">]</span>
            <span class="n">predicate</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Disaster</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="k">lambda</span> <span class="n">disaster</span><span class="p">:</span> <span class="n">disaster</span><span class="o">.</span><span class="n">month</span> <span class="ow">in</span> <span class="n">months</span>
            <span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">take_disaster_subset</span><span class="p">(</span><span class="n">predicate</span><span class="p">)</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">take_disaster_subset</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">disaster</span><span class="p">:</span> <span class="n">disaster</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">min_year</span>
            <span class="ow">and</span> <span class="n">disaster</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">max_year</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">dataset</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_select_demand</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">DisasterImpact</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">monthly_demand</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">care_about_month_demand</span>
            <span class="k">else</span> <span class="n">dataset</span><span class="o">.</span><span class="n">general_demand</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">location</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">disaster</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">disasters</span>
            <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">disaster</span><span class="o">.</span><span class="n">impacted_locations</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_cost_matrix</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">,</span> <span class="n">objective</span><span class="p">:</span> <span class="n">SolverObjective</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CostMatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cost_element</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">objective</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_cost_element</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">:</span> <span class="n">DistanceInfo</span><span class="p">,</span> <span class="n">objective</span><span class="p">:</span> <span class="n">SolverObjective</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">objective</span> <span class="o">==</span> <span class="n">SolverObjective</span><span class="o">.</span><span class="n">Cost</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">cell</span><span class="o">.</span><span class="n">cost_per_ton</span>
        <span class="k">elif</span> <span class="n">objective</span> <span class="o">==</span> <span class="n">SolverObjective</span><span class="o">.</span><span class="n">Time</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cell</span><span class="o">.</span><span class="n">time</span>
        <span class="k">elif</span> <span class="n">objective</span> <span class="o">==</span> <span class="n">SolverObjective</span><span class="o">.</span><span class="n">Distance</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cell</span><span class="o">.</span><span class="n">distance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Undefined objective </span><span class="si">{</span><span class="n">objective</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_post_process</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
        <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">,</span>
        <span class="n">costs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">SolverObjective</span><span class="p">,</span> <span class="n">CostMatrix</span><span class="p">],</span>
        <span class="n">solutions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">SolutionTags</span><span class="p">,</span> <span class="n">Solution</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="n">beta_source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">persons_per_item_monthly</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">care_about_month_demand</span>
            <span class="k">else</span> <span class="n">dataset</span><span class="o">.</span><span class="n">persons_per_item_general</span>
        <span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">location</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">beta_source</span><span class="p">[</span><span class="n">location</span><span class="p">,</span> <span class="n">item</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">disaster</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">disasters</span>
            <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">disaster</span><span class="o">.</span><span class="n">impacted_locations</span>
        <span class="p">}</span>

        <span class="n">solution_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;objective&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="p">,</span>
                    <span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="n">strategy</span><span class="p">,</span>
                    <span class="s2">&quot;coveredDemandExcDummy&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">covered_demand_exc_dummy</span><span class="p">,</span>
                    <span class="s2">&quot;dualTotInv&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">dual_total_inventory</span><span class="p">,</span>
                    <span class="s2">&quot;totalCostIncDummy&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">total_cost_inc_dummy</span><span class="p">,</span>
                    <span class="s2">&quot;totalCostExcDummy&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">total_cost_exc_dummy</span><span class="p">,</span>
                    <span class="s2">&quot;totalDemand&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">total_demand</span><span class="p">,</span>
                    <span class="s2">&quot;fractionOfDisastersUsingDummy&quot;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">fraction_of_disasters_using_dummy</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">strategy</span><span class="p">),</span> <span class="n">solution</span> <span class="ow">in</span> <span class="n">solutions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="s2">&quot;strategy&quot;</span><span class="p">])</span>

        <span class="n">df_flows</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;objective&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="p">,</span>
                    <span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="n">strategy</span><span class="p">,</span>
                    <span class="s2">&quot;disaster&quot;</span><span class="p">:</span> <span class="n">disaster</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;depot&quot;</span><span class="p">:</span> <span class="n">depot</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;impact&quot;</span><span class="p">:</span> <span class="n">impact</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">impact</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;flow&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;distance&quot;</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">distance</span><span class="p">[</span><span class="n">depot</span><span class="p">,</span> <span class="n">impact</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">mode</span><span class="p">]</span><span class="o">.</span><span class="n">distance</span>
                    <span class="k">if</span> <span class="n">depot</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="s2">&quot;DUMMY&quot;</span>
                    <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">strategy</span><span class="p">),</span> <span class="n">solution</span> <span class="ow">in</span> <span class="n">solutions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">disaster</span><span class="p">,</span> <span class="n">depot</span><span class="p">,</span> <span class="n">impact</span><span class="p">,</span> <span class="n">mode</span><span class="p">),</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">solution</span><span class="o">.</span><span class="n">flow</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Average unit cost</span>
        <span class="n">solution_stats</span><span class="p">[</span><span class="s2">&quot;averageUnitCost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solution_stats</span><span class="p">[</span><span class="s2">&quot;totalCostExcDummy&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">solution_stats</span><span class="p">[</span><span class="s2">&quot;coveredDemandExcDummy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-7</span>
        <span class="p">)</span>

        <span class="c1"># Demand fulfillment fraction</span>
        <span class="n">solution_stats</span><span class="p">[</span><span class="s2">&quot;demandFulfillmentFraction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solution_stats</span><span class="p">[</span>
            <span class="s2">&quot;coveredDemandExcDummy&quot;</span>
        <span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">solution_stats</span><span class="p">[</span><span class="s2">&quot;totalDemand&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-7</span><span class="p">)</span>

        <span class="c1"># Balance metric</span>
        <span class="n">strategies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">solution_stats</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="s2">&quot;strategy&quot;</span><span class="p">])</span>
        <span class="n">pivoted</span> <span class="o">=</span> <span class="n">solution_stats</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;totalCostExcDummy&quot;</span>
        <span class="p">)</span>
        <span class="n">pivoted</span><span class="p">[</span><span class="s2">&quot;balanceMetric&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pivoted</span><span class="p">[</span><span class="n">AllocationStrategy</span><span class="o">.</span><span class="n">MinimizeFixedInventory</span><span class="p">]</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">pivoted</span><span class="p">[</span><span class="n">AllocationStrategy</span><span class="o">.</span><span class="n">MinimizeTwoStage</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-7</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">AllocationStrategy</span><span class="o">.</span><span class="n">MinimizeFixedInventory</span> <span class="ow">in</span> <span class="n">strategies</span>
            <span class="ow">and</span> <span class="n">AllocationStrategy</span><span class="o">.</span><span class="n">MinimizeTwoStage</span> <span class="ow">in</span> <span class="n">strategies</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">balance_metric</span> <span class="o">=</span> <span class="n">pivoted</span>

        <span class="n">df_probabilities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">disaster</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">probabilities</span><span class="p">[</span><span class="n">disaster</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">disaster</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">disasters</span>
            <span class="p">},</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;probability&quot;</span><span class="p">],</span>
            <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Units shipped</span>
        <span class="n">df_flow_no_dummy</span> <span class="o">=</span> <span class="n">df_flows</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_probabilities</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;disaster&quot;</span><span class="p">)</span>
        <span class="n">df_flow_no_dummy</span> <span class="o">=</span> <span class="n">df_flow_no_dummy</span><span class="p">[</span>
            <span class="n">df_flow_no_dummy</span><span class="p">[</span><span class="s2">&quot;depot&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;DUMMY&quot;</span>
        <span class="p">]</span>  <span class="c1"># TODO Replace hardcoded dummy ID</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">df_flow_no_dummy</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;unitsShipped&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;probability&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">]</span>
        <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;unitsShippedWeighted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;unitsShipped&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span>
        <span class="n">units_shipped</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">])[</span>
                <span class="p">[</span><span class="s2">&quot;unitsShipped&quot;</span><span class="p">,</span> <span class="s2">&quot;unitsShippedWeighted&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># People served per item</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">df_flow_no_dummy</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;impact&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">loc</span><span class="p">:</span> <span class="n">beta</span><span class="p">[</span><span class="n">loc</span><span class="p">])</span>
        <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;peopleServed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;probability&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">]</span>
        <span class="n">people_served</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="s2">&quot;strategy&quot;</span><span class="p">])[</span><span class="s2">&quot;peopleServed&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="s2">&quot;strategy&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">people_served_per_item</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">people_served</span> <span class="o">/</span> <span class="p">(</span><span class="n">solution_stats</span><span class="p">[</span><span class="s2">&quot;coveredDemandExcDummy&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-7</span><span class="p">),</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;peopleServedPerItem&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Impact of optimizing one objective on another objective</span>
        <span class="n">impact</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">comparison_objectives</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">(</span><span class="n">depot</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">location</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">mode</span><span class="o">.</span><span class="n">id</span><span class="p">):</span> <span class="n">value</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">depot</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">mode</span><span class="p">),</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">costs</span><span class="p">[</span><span class="n">other</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">df_flow_no_dummy</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">temp</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Empty flow matrix encountered&quot;</span><span class="p">)</span>
            <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">cost</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;depot&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span>
            <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;impact&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;probability&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">temp</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">]</span>
            <span class="n">impact</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">())</span>
        <span class="n">cross_impact</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">impact</span><span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">])[[</span><span class="s2">&quot;impact&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">Analysis</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">item</span><span class="p">,</span>
            <span class="n">solutions</span><span class="p">,</span>
            <span class="n">solution_stats</span><span class="p">,</span>
            <span class="n">balance_metric</span><span class="p">,</span>
            <span class="n">units_shipped</span><span class="p">,</span>
            <span class="n">people_served_per_item</span><span class="p">,</span>
            <span class="n">cross_impact</span><span class="p">,</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The Analyzer class manages the analysis workflow. It can run analysis for a single item or for all items across various inventory scenarios. It utilizes the AnalyzerWorker to perform the computations and collects the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Analyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Service responsible for performing optimization runs and analysis on the results</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">AnalysisParameters</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Analysis</span><span class="p">:</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="n">AnalyzerWorker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Item</span><span class="p">],</span> <span class="n">Analysis</span><span class="p">]:</span>
        <span class="n">inventory_datasets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">filename</span><span class="p">:</span> <span class="n">dataset</span><span class="o">.</span><span class="n">take_inventory_scenario</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">inventory_scenarios</span>
        <span class="p">}</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">inventory_dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">inventory_dataset</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inventory_datasets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">inventory_dataset</span><span class="o">.</span><span class="n">items</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_tasks</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">Item</span><span class="p">]]):</span>
        <span class="n">use_multi_processing</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CI&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span>
        <span class="n">use_multi_processing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">use_multi_processing</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span>
                <span class="n">initializer</span><span class="o">=</span><span class="n">_analysis_worker_init</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">result</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Analysis</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                    <span class="n">_analysis_worker_call</span><span class="p">,</span> <span class="n">tasks</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="n">AnalyzerWorker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tasks</span>
            <span class="p">]</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">analysis</span><span class="o">.</span><span class="n">item</span><span class="p">):</span> <span class="n">analysis</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">analysis</span><span class="p">)</span> <span class="ow">in</span> <span class="n">result</span>
            <span class="k">if</span> <span class="n">analysis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>These next two functiomns function initializes a global worker for use in multiprocessing scenarios and calls the run method of the global worker with the provided arguments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_analysis_worker_init</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">worker</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="n">AnalyzerWorker</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_analysis_worker_call</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Item</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Analysis</span><span class="p">]:</span>
    <span class="k">global</span> <span class="n">worker</span>
    <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="o">=</span> <span class="n">arg</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="geting-it-ready-for-optimization">
<h2>Geting it ready for Optimization<a class="headerlink" href="#geting-it-ready-for-optimization" title="Link to this heading">#</a></h2>
<p>Let’s take a look at thow the data is formated to be used in our solver. First we will set the context of our problemn</p>
</section>
<section id="solver">
<h2>Solver<a class="headerlink" href="#solver" title="Link to this heading">#</a></h2>
<p>The loop</p>
<p>Why the Prevalent Use of Dictionaries vs Lists?
Dictionaries are often favored over lists in production code for several reasons:</p>
<ul class="simple">
<li><p>Key-Value Pairs: Dictionaries provide a convenient way to store and retrieve data by keys rather than by index. This makes dictionaries especially useful for scenarios where data is logically organized by unique identifiers (e.g., JSON-like structures, configurations).</p></li>
<li><p>Readability and Maintainability: With dictionaries, code becomes more readable and self-explanatory. For example, user[‘name’] is more descriptive than user[0].</p></li>
<li><p>Flexibility in Data Manipulation: Unlike lists, dictionaries allow quick updates and deletions by key, improving flexibility when modifying data.</p></li>
<li><p>Performance: For lookups, inserts, and deletions, dictionaries (hash maps) often provide average O(1) time complexity, while lists require O(n) for searching or removing elements unless the position is already known.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntEnum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">gurobipy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">gurobipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">GRB</span><span class="p">,</span> <span class="n">tupledict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depot</span><span class="p">,</span> <span class="n">Disaster</span><span class="p">,</span> <span class="n">DisasterImpact</span><span class="p">,</span> <span class="n">Location</span><span class="p">,</span> <span class="n">TransportMode</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AllocationStrategy</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The AllocationStrategy enumeration defines different strategies for allocating inventory in </span>
<span class="sd">    our optimization model</span>

<span class="sd">    MinimizeTwoStage: Allows inventory reallocation in both stages of the model.</span>

<span class="sd">    MinimizeFixedInventory: Keeps the inventory fixed as in the initial state.</span>

<span class="sd">    WorstDepot: Allocates all inventory to the worst-performing depot to test the model&#39;s robustness.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">MinimizeTwoStage</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">MinimizeFixedInventory</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">WorstDepot</span> <span class="o">=</span> <span class="mi">2</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">The SolverParameters class holds configuration settings for the solver.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SolverParameters</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters that influence how the solver transforms the Problem into a mathematical model.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    allocation_strategy</span>
<span class="sd">        If and how inventory can be reallocated</span>
<span class="sd">    scale_demand</span>
<span class="sd">        Whether demand should be scaled (down) to not exceed supply</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">allocation_strategy</span><span class="p">:</span> <span class="n">AllocationStrategy</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">AllocationStrategy</span><span class="o">.</span><span class="n">MinimizeFixedInventory</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">scale_demand</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">We define a type alias CostMatrix for readability. It represents a dictionary mapping a </span>
<span class="sd">tuple of (source location, target location, transport mode) to a cost value (e.g., transportation </span>
<span class="sd">cost, time, or distance). This matrix is essential for the optimization model to calculate </span>
<span class="sd">costs associated with moving goods from depots to disaster impact locations.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">CostMatrix</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Location</span><span class="p">,</span> <span class="n">Location</span><span class="p">,</span> <span class="n">TransportMode</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Problem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The Problem class encapsulates all the data required to define an optimization problem:</span>

<span class="sd">    depots: A list of depots where inventory is stored.</span>
<span class="sd">    </span>
<span class="sd">    inventory: A dictionary mapping each depot to the quantity of inventory it holds.</span>
<span class="sd">    </span>
<span class="sd">    demand: A dictionary mapping each DisasterImpact location to its demand.</span>
<span class="sd">    </span>
<span class="sd">    disasters: A list of disasters being considered.</span>
<span class="sd">    </span>
<span class="sd">    probabilities: A dictionary mapping each disaster to its probability of occurrence.</span>
<span class="sd">    </span>
<span class="sd">    transport_modes: A list of available transport modes.</span>
<span class="sd">    </span>
<span class="sd">    cost: The CostMatrix containing cost information for transporting goods.*</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">depots</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Depot</span><span class="p">]</span>
    <span class="n">inventory</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Depot</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">demand</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">DisasterImpact</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">disasters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Disaster</span><span class="p">]</span>
    <span class="n">probabilities</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Disaster</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">transport_modes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TransportMode</span><span class="p">]</span>
    <span class="n">cost</span><span class="p">:</span> <span class="n">CostMatrix</span>
</pre></div>
</div>
</div>
</div>
<p>The Solution class stores the results obtained after solving a Problem with specific SolverParameters. It includes various metrics and variables that describe the performance and decisions made by the optimization model, such as total costs, demand coverage, dual variables, and optimal flows. The _dummy_depot is a special depot used internally to handle unmet demand in the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Solution</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Result of solving a single Problem with specific SolverParameters</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    total_cost_inc_dummy</span>
<span class="sd">        Total transportation cost including artificial cost for using the dummy node (myObj)</span>
<span class="sd">    total_cost_exc_dummy</span>
<span class="sd">        Total transportation cost from the real depots (myObjNoDum)</span>
<span class="sd">    total_demand</span>
<span class="sd">        Total demand in the input data (myWeightedDemand)</span>
<span class="sd">    covered_demand_exc_dummy</span>
<span class="sd">        Demand served from real depots, averaged over all scenarios (myWeightedDemandMetNoDum)</span>
<span class="sd">    fraction_of_disasters_using_dummy</span>
<span class="sd">        Fraction of disaster scenarios for which not enough real inventory is available (myFractionOfDisastersUsingDummy)</span>
<span class="sd">    duals_inventory_exc_dummy_plus_dummy_cost</span>
<span class="sd">        Adjusted dual variables for the inventory constraints (values are independent of dummy costs) (dualsInvNoDum_PlusDummyCost)</span>
<span class="sd">    duals_inventory_exc_dummy_unadjusted</span>
<span class="sd">        Original dual variables for the inventory constraints, aggregated over disaster scenarios (dualsInvNoDum_UnAdj)</span>
<span class="sd">    duals_inventory_exc_dummy_all</span>
<span class="sd">        All original dual variables for the inventory constraints (dualsInvNoDum_All)</span>
<span class="sd">    flow_exc_dummy</span>
<span class="sd">        Allocation of depot inventory to disaster locations in each scenario, excluding the dummy depot (myFlowNoDum)</span>
<span class="sd">    flow</span>
<span class="sd">        Allocation of depot inventory to disaster locations in each scenario (myFlow)</span>
<span class="sd">    optimal_inventory</span>
<span class="sd">        Optimal or fixed allocation of inventory to depots (myOptInvNoDum)</span>
<span class="sd">    dual_total_inventory</span>
<span class="sd">        Dual variable for the total inventory constraint (dualTotInv)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">total_cost_inc_dummy</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">total_cost_exc_dummy</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">total_demand</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">covered_demand_exc_dummy</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">fraction_of_disasters_using_dummy</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">duals_inventory_exc_dummy_plus_dummy_cost</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Depot</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">duals_inventory_exc_dummy_unadjusted</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Depot</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">duals_inventory_exc_dummy_all</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Disaster</span><span class="p">,</span> <span class="n">Depot</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">flow_exc_dummy</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Disaster</span><span class="p">,</span> <span class="n">Depot</span><span class="p">,</span> <span class="n">DisasterImpact</span><span class="p">,</span> <span class="n">TransportMode</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">flow</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Disaster</span><span class="p">,</span> <span class="n">Depot</span><span class="p">,</span> <span class="n">DisasterImpact</span><span class="p">,</span> <span class="n">TransportMode</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">optimal_inventory</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Depot</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">dual_total_inventory</span><span class="p">:</span> <span class="nb">float</span>

    <span class="n">_dummy_depot</span><span class="p">:</span> <span class="n">Depot</span>
</pre></div>
</div>
</div>
</div>
<p>The StochasticSolver class encapsulates the logic for solving stochastic optimization problems. The class variables _threshold_cost_elim and _threshold_cost_dummy are large constants used to effectively eliminate certain arcs or penalize the use of the dummy depot in the optimization model. The constructor initializes a dummy location and creates a Gurobi environment with specific parameters (e.g., disabling output and setting single-threaded execution).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StochasticSolver</span><span class="p">:</span>
    <span class="n">_threshold_cost_elim</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e9</span>
    <span class="n">_threshold_cost_dummy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e9</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dummy</span> <span class="o">=</span> <span class="n">Location</span><span class="p">(</span><span class="s2">&quot;DUMMY&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">Env</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;OutputFlag&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Threads&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The dispose method releases resources associated with the Gurobi environment. </span>
<span class="sd">    It&#39;s important to call this method after solving problems to prevent resource </span>
<span class="sd">    leaks, especially when solving multiple problems in a loop.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="kc">None</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    In the solve method, we begin by preparing the data for the optimization model:</span>
<span class="sd">    </span>
<span class="sd">    We include both real depots and the dummy depot in our list of sources.</span>
<span class="sd">    </span>
<span class="sd">    Demand scaling is performed if specified in the parameters.</span>
<span class="sd">    </span>
<span class="sd">    We construct the list of possible arcs in the transportation network, filtering out those with </span>
<span class="sd">    prohibitive costs unless they involve the dummy depot.</span>
<span class="sd">    </span>
<span class="sd">    We calculate the cost for each arc, adjusting for disaster probabilities to reflect the expected</span>
<span class="sd">    cost across scenarios.</span>
<span class="sd">    </span>
<span class="sd">    We initialize a Gurobi model named &quot;StochLP&quot; for solving the stochastic linear program</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">:</span> <span class="n">Problem</span><span class="p">,</span> <span class="n">parameters</span><span class="p">:</span> <span class="n">SolverParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Solution</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">depots</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dummy</span><span class="p">]</span>

        <span class="n">demand</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scale_demand</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span> <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">scale_demand</span> <span class="k">else</span> <span class="n">problem</span><span class="o">.</span><span class="n">demand</span>
        <span class="p">)</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The arcs represent the possible transportation routes from the supply sources (depots and a dummy depot)</span>
<span class="sd">        to the disaster-impacted locations for each disaster scenario and transport mode. Specifically, </span>
<span class="sd">        each arc is a tuple (k, i, j, v) where:</span>

<span class="sd">        k i a disaster scenario from the list of disasters being considered.</span>
<span class="sd">        </span>
<span class="sd">        i is a source location, which can be a real depot or a special dummy depot used to model unmet demand.</span>
<span class="sd">        </span>
<span class="sd">        j is a disaster impact location, representing an area affected by disaster k where relief goods are needed.</span>
<span class="sd">        </span>
<span class="sd">        v is a transport mode, such as road, air, or sea transport.</span>
<span class="sd">        These arcs form the edges of the transportation network in the model. They define all feasible routes along </span>
<span class="sd">        which relief items can be transported from depots to impacted locations under different disaster scenarios and transportation options.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">arcs</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">tuplelist</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sources</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">disasters</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">impacted_locations</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">transport_modes</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_arc_cost</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threshold_cost_elim</span>
                <span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dummy</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">arc_cost</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arc_cost</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">problem</span><span class="o">.</span><span class="n">probabilities</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">arcs</span>
        <span class="p">}</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="s2">&quot;StochLP&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>

        <span class="c1"># First stage variable: Quantity to be allocated to each depot</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">tupledict</span><span class="p">[</span><span class="n">Depot</span><span class="p">,</span> <span class="n">gp</span><span class="o">.</span><span class="n">Var</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">addVars</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">depots</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="c1"># Second stage variable: Quantity transported from (real or dummy) depot to disaster locations using each mode of transport</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">tupledict</span><span class="p">[</span>
            <span class="n">Tuple</span><span class="p">[</span><span class="n">Disaster</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Depot</span><span class="p">,</span> <span class="n">Location</span><span class="p">],</span> <span class="n">DisasterImpact</span><span class="p">,</span> <span class="n">TransportMode</span><span class="p">],</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">Var</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">addVars</span><span class="p">(</span><span class="n">arcs</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">arc_cost</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

        <span class="c1"># Constraint: Total incoming arc flow must cover demand for each disaster location</span>
        <span class="n">model</span><span class="o">.</span><span class="n">addConstrs</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">y</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">demand</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">disasters</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">impacted_locations</span>
            <span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;satisfyDemand&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Constraint: Total outgoing arc flow must match initial or reallocated inventory</span>
        <span class="n">inventory_balance</span><span class="p">:</span> <span class="n">tupledict</span><span class="p">[</span>
            <span class="n">Tuple</span><span class="p">[</span><span class="n">Disaster</span><span class="p">,</span> <span class="n">Depot</span><span class="p">],</span> <span class="n">gp</span><span class="o">.</span><span class="n">Constr</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">addConstrs</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">y</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">disasters</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">depots</span>
            <span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;satisfySupply&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Constraint: Ensure inventory reallocation matches total existing inventory</span>
        <span class="n">total_initial_inventory</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">match_total_inventory</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">addConstr</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="n">total_initial_inventory</span><span class="p">)</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        We define a helper function fix_inventory_balance to fix the inventory variables (x) to specific values, </span>
<span class="sd">        effectively turning them into constants in the model. Based on the allocation_strategy</span>
<span class="sd">        </span>
<span class="sd">        MinimizeFixedInventory: We fix the inventory variables to their initial values, preventing reallocation.</span>
<span class="sd">        </span>
<span class="sd">        WorstDepot: We iterate over all depots, allocating all inventory to each one individually to find the depot </span>
<span class="sd">        that results in the worst (highest) objective value. We then fix the inventory allocation to that depot, </span>
<span class="sd">        which is useful for stress-testing the model&#39;s performance under adverse conditions.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">fix_inventory_balance</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Disaster</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">LB</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">UB</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">allocation_strategy</span> <span class="o">==</span> <span class="n">AllocationStrategy</span><span class="o">.</span><span class="n">MinimizeFixedInventory</span><span class="p">:</span>
            <span class="n">fix_inventory_balance</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">inventory</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">parameters</span><span class="o">.</span><span class="n">allocation_strategy</span> <span class="o">==</span> <span class="n">AllocationStrategy</span><span class="o">.</span><span class="n">WorstDepot</span><span class="p">:</span>
            <span class="n">worst_depot</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">worst_objective</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e100</span>
            <span class="k">for</span> <span class="n">depot</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">depots</span><span class="p">:</span>
                <span class="n">centralized_inventory</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">other</span><span class="p">:</span> <span class="n">total_initial_inventory</span> <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="n">depot</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">depots</span>
                <span class="p">}</span>
                <span class="n">fix_inventory_balance</span><span class="p">(</span><span class="n">centralized_inventory</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">GRB</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">OPTIMAL</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not solve model to optimality&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">ObjVal</span> <span class="o">&gt;</span> <span class="n">worst_objective</span><span class="p">:</span>
                    <span class="n">worst_depot</span> <span class="o">=</span> <span class="n">depot</span>
                    <span class="n">worst_objective</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ObjVal</span>
            <span class="n">centralized_inventory</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">other</span><span class="p">:</span> <span class="n">total_initial_inventory</span> <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="n">worst_depot</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">depots</span>
            <span class="p">}</span>
            <span class="n">fix_inventory_balance</span><span class="p">(</span><span class="n">centralized_inventory</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">GRB</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">OPTIMAL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not solve model to optimality&quot;</span><span class="p">)</span>

        <span class="c1"># Total transport cost</span>
        <span class="n">total_cost_inc_dummy</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ObjVal</span>
        <span class="n">dummy_cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">var</span><span class="o">.</span><span class="n">X</span> <span class="o">*</span> <span class="n">var</span><span class="o">.</span><span class="n">Obj</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">y</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dummy</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">total_cost_exc_dummy</span> <span class="o">=</span> <span class="n">total_cost_inc_dummy</span> <span class="o">-</span> <span class="n">dummy_cost</span>

        <span class="c1"># Demand met without using the dummy node</span>
        <span class="n">covered_demand_by_dummy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">X</span> <span class="o">*</span> <span class="n">problem</span><span class="o">.</span><span class="n">probabilities</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">arcs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dummy</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">total_demand</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">local_demand</span> <span class="o">*</span> <span class="n">problem</span><span class="o">.</span><span class="n">probabilities</span><span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">disaster</span><span class="p">]</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">local_demand</span><span class="p">)</span> <span class="ow">in</span> <span class="n">demand</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">covered_demand_exc_dummy</span> <span class="o">=</span> <span class="n">total_demand</span> <span class="o">-</span> <span class="n">covered_demand_by_dummy</span>

        <span class="c1"># Flow in solution</span>
        <span class="n">solution_y</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">y</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">X</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">arcs</span><span class="p">}</span>

        <span class="c1"># Fraction of disaster scenarios in which the dummy supply is used</span>
        <span class="n">fraction_of_disasters_using_dummy</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">disaster</span>
                <span class="k">for</span> <span class="n">disaster</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">disasters</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="n">solution_y</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">arcs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">disaster</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dummy</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">disasters</span><span class="p">)</span>

        <span class="c1"># Dual variables for the inventory balance constraints</span>
        <span class="n">dual_correction</span> <span class="o">=</span> <span class="n">fraction_of_disasters_using_dummy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threshold_cost_dummy</span>
        <span class="n">duals_inventory_exc_dummy_unadjusted</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">inventory_balance</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Pi</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">disasters</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">depots</span>
        <span class="p">}</span>
        <span class="n">duals_inventory_exc_dummy_plus_dummy_cost</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">:</span> <span class="n">dual_correction</span> <span class="o">+</span> <span class="n">pi</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">pi</span><span class="p">)</span> <span class="ow">in</span> <span class="n">duals_inventory_exc_dummy_unadjusted</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">duals_inventory_exc_dummy_all</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span> <span class="n">constr</span><span class="o">.</span><span class="n">Pi</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">constr</span> <span class="ow">in</span> <span class="n">inventory_balance</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">flow</span> <span class="o">=</span> <span class="p">{(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span> <span class="n">var</span><span class="o">.</span><span class="n">X</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">y</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">X</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>

        <span class="n">flow_exc_dummy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span> <span class="n">value</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">flow</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dummy</span>
        <span class="p">}</span>

        <span class="n">optimal_inventory</span> <span class="o">=</span> <span class="p">{</span><span class="n">depot</span><span class="p">:</span> <span class="n">var</span><span class="o">.</span><span class="n">X</span> <span class="k">for</span> <span class="n">depot</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">dual_total_inventory</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">match_total_inventory</span><span class="o">.</span><span class="n">Pi</span>
            <span class="k">if</span> <span class="n">parameters</span><span class="o">.</span><span class="n">allocation_strategy</span>
            <span class="o">==</span> <span class="n">AllocationStrategy</span><span class="o">.</span><span class="n">MinimizeFixedInventory</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finally, we package all the extracted metrics and variables into a Solution object and return it. This object </span>
<span class="sd">        provides a comprehensive view of the optimization results, enabling further analysis or reporting.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="n">Solution</span><span class="p">(</span>
            <span class="n">total_cost_inc_dummy</span><span class="p">,</span>
            <span class="n">total_cost_exc_dummy</span><span class="p">,</span>
            <span class="n">total_demand</span><span class="p">,</span>
            <span class="n">covered_demand_exc_dummy</span><span class="p">,</span>
            <span class="n">fraction_of_disasters_using_dummy</span><span class="p">,</span>
            <span class="n">duals_inventory_exc_dummy_plus_dummy_cost</span><span class="p">,</span>
            <span class="n">duals_inventory_exc_dummy_unadjusted</span><span class="p">,</span>
            <span class="n">duals_inventory_exc_dummy_all</span><span class="p">,</span>
            <span class="n">flow_exc_dummy</span><span class="p">,</span>
            <span class="n">flow</span><span class="p">,</span>
            <span class="n">optimal_inventory</span><span class="p">,</span>
            <span class="n">dual_total_inventory</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dummy</span><span class="p">,</span>
        <span class="p">)</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The _get_arc_cost method retrieves the cost of transporting goods from a source to a target using a specific transport mode. If the </span>
<span class="sd">    source is the dummy depot, it returns a high dummy cost to penalize </span>
<span class="sd">    its use. If there is no cost information available for a given arc </span>
<span class="sd">    (i.e., cell is None), it returns a high elimination threshold cost </span>
<span class="sd">    to effectively remove that arc from consideration.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_arc_cost</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cost</span><span class="p">:</span> <span class="n">CostMatrix</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Location</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">DisasterImpact</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">TransportMode</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dummy</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threshold_cost_dummy</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">cost</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threshold_cost_elim</span> <span class="k">if</span> <span class="n">cell</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cell</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The _scale_demand method adjusts the demand levels so that total demand </span>
<span class="sd">    does not exceed total supply. For each disaster, it calculates a scaling </span>
<span class="sd">    factor based on the ratio of total supply to total demand. It then applies </span>
<span class="sd">    this factor to the demand at each impacted location. This is useful in scenarios </span>
<span class="sd">    where supply constraints are tight, ensuring that the optimization model </span>
<span class="sd">    operates within feasible limits.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_scale_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">:</span> <span class="n">Problem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">DisasterImpact</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">supply</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">DisasterImpact</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">disaster</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">disasters</span><span class="p">:</span>
            <span class="n">total_demand</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="n">problem</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">disaster</span><span class="o">.</span><span class="n">impacted_locations</span>
            <span class="p">)</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">supply</span> <span class="o">/</span> <span class="n">total_demand</span><span class="p">)</span> <span class="k">if</span> <span class="n">total_demand</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">disaster</span><span class="o">.</span><span class="n">impacted_locations</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">problem</span><span class="o">.</span><span class="n">demand</span><span class="p">[</span><span class="n">location</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<p>After diving into the code, it’s clear that it’s exceptionally well-crafted, following best practices and maintaining high readability. The lead developer shared some key insights that contributed to this level of quality. These takeaways not only explain how the code reached its current state but also offer valuable lessons for future projects. Let’s explore these insights to understand what makes the code stand out.</p>
<ol class="arabic">
<li><p><strong>Balancing Commenting on Different Projects with Different People Involved</strong></p>
<p>When working on different projects involving different teams, it is crucial to adapt your commenting style to meet the team’s specific needs and coding standards. Here are some tips for balancing commenting styles across projects:</p>
<ul class="simple">
<li><p>Understand Team Preferences: Some teams prefer more verbose comments to ensure all members understand the code, while others might lean towards minimal commenting to keep code clean. Spend time understanding each team’s culture and coding standards.</p></li>
<li><p>Project-specific Documentation: Tailor the level and style of commenting to fit the project’s needs. For example, a data science team might require detailed explanations of algorithms and mathematical steps, while a software engineering team may focus more on architectural and functional documentation.</p></li>
<li><p>Reusable Templates: Create reusable templates or guidelines for comments that can be adapted easily for each project. For instance, standardize on docstring formats (e.g., Google-style, reStructuredText) and comment structures that can be tweaked as per the project’s requirements.</p></li>
<li><p>Consistency is Key: Regardless of the project, maintain consistency in your commenting style within a single codebase. This reduces cognitive load and makes it easier for team members to understand the code quickly.</p></li>
<li><p>Communicate Clearly: Have an open discussion with your teammates about their preferences. Clearly defined comment guidelines should be set and documented at the beginning of each project.</p></li>
</ul>
</li>
<li><p><strong>Why the Prevalent Use of Dictionaries vs Lists?</strong>
In the provided code examples, dictionaries are extensively used over lists, and this choice offers several advantages:</p>
<ul>
<li><p><strong>Key-Value Access</strong>: Dictionaries allow for fast retrieval of data using keys, which is essential when dealing with entities identified by unique attributes. For example, the Dataset class uses dictionaries like inventory, probabilities, and distance to map complex relationships between depots, disasters, and locations.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">inventory</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Depot</span><span class="p">,</span> <span class="n">Item</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span>
<span class="n">DistanceMatrix</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Location</span><span class="p">,</span> <span class="n">Location</span><span class="p">,</span> <span class="n">TransportMode</span><span class="p">],</span> <span class="n">DistanceInfo</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p><strong>Readability</strong>: Using dictionaries makes the code more self-explanatory. Accessing <code class="docutils literal notranslate"><span class="pre">inventory[(depot,</span> <span class="pre">item)]</span></code> is clearer than using index-based access in a list, improving code readability.</p></li>
<li><p><strong>Performance</strong>: Dictionaries provide average O(1) time complexity for lookups, which is beneficial when working with large datasets, as is common in disaster logistics modeling.</p></li>
</ul>
</li>
</ol>
<ol class="arabic" start="3">
<li><p><strong>Testing and Debugging</strong></p>
<p>Testing and debugging are crucial for ensuring the reliability of production code, especially in complex systems like our stochastic solver where very real world impacts can occur if bugs go un-noticed. We haven’t shown them specifically here for brevity, however, let’s take a look at how we change our code to accomidate them:</p>
<ul>
<li><p><strong>Error Handling</strong>: In the StochasticSolver class, we include checks after optimization to ensure that the model has reached an optimal solution. If not, we raise a RuntimeError with a clear message. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
<span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">Status</span> <span class="o">!=</span> <span class="n">GRB</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">OPTIMAL</span><span class="p">:</span>
	<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not solve model to optimality&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Modularity for Testing</strong>: The code is organized into modular functions and methods, such as _get_arc_cost and _scale_demand, which makes unit testing more manageable. Each function can be tested independently to verify that it behaves as expected.</p>
<ul class="simple">
<li><p><strong>Unit Tests</strong>: Write unit tests for every function or module to ensure that each part works as expected independently. Unit tests should be automated and run frequently to catch errors early.</p></li>
<li><p><strong>Integration Tests</strong>: Test interactions between different modules to catch integration-related issues. Use mocking or stubbing to isolate dependencies when needed.</p></li>
<li><p><strong>Logging</strong>: Make effective use of logging with different levels (DEBUG, INFO, WARNING, ERROR, CRITICAL). Logging provides a way to understand what the code was doing at the time an error occurred without having to run it in a debugging mode.</p></li>
</ul>
</li>
</ul>
</li>
</ol>
<ol class="arabic" start="4">
<li><p><strong>Any Particular Naming Rules? Discuss with Others</strong></p>
<p>Consistent and meaningful naming conventions are crucial for collaboration:</p>
<ul class="simple">
<li><p><strong>CamelCase vs. snake_case</strong>: Choose a naming convention that fits the projectand stick with it throughout the codebase. In this case we have:</p>
<ul>
<li><p>CamelCase for classes like <code class="docutils literal notranslate"><span class="pre">DisasterImpact</span></code>, <code class="docutils literal notranslate"><span class="pre">AnalyzerWorker</span></code>, and <code class="docutils literal notranslate"><span class="pre">StochasticSolver</span></code></p></li>
<li><p>snake_case for variables and functions like <code class="docutils literal notranslate"><span class="pre">total_cost_inc_dummy</span></code>, <code class="docutils literal notranslate"><span class="pre">_filter_dataset</span></code>, and <code class="docutils literal notranslate"><span class="pre">optimal_inventory</span></code> )</p></li>
</ul>
</li>
<li><p><strong>Descriptive Names</strong>: Use descriptive names that clearly indicate the purpose of a variable, function, or class. Avoid abbreviations unless they are standard and well-known.</p></li>
<li><p><strong>Prefixed Naming</strong>: When needed, prefix variables to indicate their type or usage (is_ for booleans, num_ for numbers, str_ for strings). This is more common in languages with weaker type systems.</p></li>
<li><p><strong>Team Agreements</strong>: Have a discussion with your team to establish a naming convention that everyone agrees on. Document these conventions in a style guide that is accessible to all team members.</p></li>
</ul>
</li>
</ol>
<ol class="arabic" start="5">
<li><p><strong>Error Handling</strong></p>
<p>Proper error handling is vital to ensure robustness in production code:</p>
<ul>
<li><p><strong>Specific Exceptions</strong>: The code raises specific exceptions with informative messages. For example, in the <code class="docutils literal notranslate"><span class="pre">take_inventory_scenario</span></code> method of the Dataset class, a RuntimeError is raised if an inventory scenario is not found</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">filename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_scenarios</span><span class="p">:</span>
<span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Inventory scenario not found&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Fallback Mechanisms</strong>: In the solver, when a solution is not optimal, the code doesn’t proceed blindly but instead stops execution, which prevents cascading errors and makes debugging easier.</p></li>
<li><p><strong>Validation Checks</strong>: Before performing operations, the code often checks for potential issues, such as verifying that the total inventory is not zero before proceeding with the optimization.</p></li>
</ul>
</li>
</ol>
<ol class="arabic" start="6">
<li><p><strong>Global Variables</strong></p>
<p>Global variables should generally be avoided in production code due to potential issues with maintainability and concurrency:</p>
<ul>
<li><p><strong>Encapsulation</strong>:Encapsulate variables within classes or functions to limit their scope and prevent unintended modifications. Classes like <code class="docutils literal notranslate"><span class="pre">AnalyzerWorker</span></code> and <code class="docutils literal notranslate"><span class="pre">StochasticSolver</span></code> encapsulate their data and methods, preventing external interference.</p></li>
<li><p><strong>Controlled Scope</strong>: In multiprocessing scenarios, global variables are used judiciously. For instance, a global worker is initialized in the <code class="docutils literal notranslate"><span class="pre">_analysis_worker_init</span></code> function for use in worker processes, but its scope is limited and managed carefully.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_analysis_worker_init</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">worker</span>
	<span class="n">worker</span> <span class="o">=</span> <span class="n">AnalyzerWorker</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

</pre></div>
</div>
</li>
<li><p><strong>Unintended Side Effects</strong>: Global variables can lead to unexpected side effects, making the code harder to debug and maintain.</p></li>
<li><p><strong>Thread Safety</strong>: In multi-threaded applications, global variables can lead to race conditions if not handled properly.</p></li>
<li><p><strong>Use Constants Judiciously</strong>: If you must use global variables, restrict them to constants (immutable values) and use them sparingly.</p></li>
</ul>
</li>
</ol>
<ol class="arabic" start="7">
<li><p><strong>Typing</strong></p>
<p>Strong typing adds robustness and clarity to production code:</p>
<ul>
<li><p><strong>Function Annotations</strong>: Methods specify the types of their arguments and return values, which aids in understanding what kinds of data are expected.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">_get_cost_element</span><span class="p">(</span>
	<span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">:</span> <span class="n">DistanceInfo</span><span class="p">,</span> <span class="n">objective</span><span class="p">:</span> <span class="n">SolverObjective</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">):</span>
</pre></div>
</div>
</li>
<li><p><strong>Type Aliases</strong>: Defining type aliases like CostMatrix and DistanceMatrix makes complex types more readable and maintainable.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CostMatrix</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Location</span><span class="p">,</span> <span class="n">Location</span><span class="p">,</span> <span class="n">TransportMode</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p><strong>Static Type Checking</strong>: Using type hints allows tools like mypy to perform static type checking, catching potential type errors before runtime.</p></li>
</ul>
</li>
</ol>
<p>By following these principles, you can improve code quality, collaboration, and maintainability in a production environment, while also tailoring your practices to different projects and teams.</p>
</section>
<section id="runing-it-all">
<h2>Runing it All<a class="headerlink" href="#runing-it-all" title="Link to this heading">#</a></h2>
<p>So what would runing all this look like? Lets take a look!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">COUNTRY</span> <span class="o">=</span> <span class="s2">&quot;vanuatu_simple&quot;</span>

<span class="c1"># Run optimization</span>
<span class="n">reader</span> <span class="o">=</span> <span class="n">CsvProblemReader</span><span class="p">()</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">/</span> <span class="n">COUNTRY</span><span class="p">)</span>

<span class="n">parameters</span> <span class="o">=</span> <span class="n">AnalysisParameters</span><span class="p">()</span>
<span class="n">analyzer</span> <span class="o">=</span> <span class="n">Analyzer</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">analyzer</span><span class="o">.</span><span class="n">run_all</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

<span class="n">exisiting_stock_df</span> <span class="o">=</span> <span class="n">calc_exisiting_stock_df</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="n">COUNTRY</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s save the outputs</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">WORKSPACE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">WORKSPACE_DIR</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span>
<span class="n">TEST_DATA_DIR</span> <span class="o">=</span> <span class="n">WORKSPACE_DIR</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;test_data&quot;</span>
<span class="n">DASHBOARD_OUTPUT_PATH</span> <span class="o">=</span> <span class="n">WORKSPACE_DIR</span> <span class="o">/</span> <span class="s2">&quot;dashboard_output&quot;</span>


<span class="n">priority_change_df</span> <span class="o">=</span> <span class="n">create_priority_change</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="n">COUNTRY</span><span class="p">)</span>

<span class="n">all_duals_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">scenario</span> <span class="o">=</span> <span class="n">get_scenario</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scenario</span> <span class="o">!=</span> <span class="s2">&quot;actual&quot;</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="n">duals_df</span> <span class="o">=</span> <span class="n">calc_duals_by_warehouse</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">all_duals_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">all_duals_df</span><span class="p">,</span> <span class="n">duals_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_metrics</span><span class="p">():</span>
    <span class="c1">### ProvinceAssessDF dashboard file</span>
    <span class="n">provinces_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DATA_DIR</span> <span class="o">/</span> <span class="n">COUNTRY</span> <span class="o">/</span> <span class="s2">&quot;province_lookup.csv&quot;</span><span class="p">)</span>
    <span class="n">provinces_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">ProvinceLookupDF</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">provinces_df</span><span class="p">)</span>
    <span class="n">province_assess_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">create_province_assess_df</span><span class="p">(</span>
        <span class="n">all_duals_df</span><span class="p">,</span>
        <span class="n">provinces_df</span><span class="p">,</span>
        <span class="n">COUNTRY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">### WhStockAssessDF dashboard file</span>
    <span class="n">duals_df_copy</span> <span class="o">=</span> <span class="n">all_duals_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">wh_stock_assess</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">item_stock_assess</span><span class="p">(</span><span class="n">duals_df_copy</span><span class="p">,</span> <span class="n">provinces_df</span><span class="p">,</span> <span class="n">COUNTRY</span><span class="p">)</span>


    <span class="c1">### Reallocation dashboard file</span>
    <span class="n">reallocation_df</span><span class="p">,</span> <span class="n">single_warehouse_df</span> <span class="o">=</span> <span class="n">reallocation_dashboard_files</span><span class="p">(</span>
        <span class="n">wh_stock_assess</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">result</span><span class="p">,</span>
        <span class="n">COUNTRY</span><span class="p">,</span>
        <span class="n">wh_stock_assess</span><span class="o">=</span><span class="n">wh_stock_assess</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">### Disaster totals dashboard file</span>
    <span class="n">dis_totals_df</span> <span class="o">=</span> <span class="n">create_disaster_totals</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">COUNTRY</span><span class="p">)</span>


    <span class="c1">### Save dashboard files</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">DASHBOARD_OUTPUT_PATH</span> <span class="o">/</span> <span class="n">COUNTRY</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="p">(</span><span class="n">DASHBOARD_OUTPUT_PATH</span> <span class="o">/</span> <span class="n">COUNTRY</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">exisiting_stock_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="n">DASHBOARD_OUTPUT_PATH</span> <span class="o">/</span> <span class="n">COUNTRY</span> <span class="o">/</span> <span class="s2">&quot;exisiting_stock.csv&quot;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">priority_change_df</span> <span class="o">=</span> <span class="n">priority_change_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="n">priority_change_df</span><span class="p">[</span><span class="n">BalMetricsDashboard</span><span class="o">.</span><span class="n">run_pct</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;actual&quot;</span>
    <span class="p">]</span>
    <span class="n">priority_change_df</span> <span class="o">=</span> <span class="n">priority_change_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">BalMetricsDashboard</span><span class="o">.</span><span class="n">run_pct</span><span class="p">])</span>
    <span class="n">priority_change_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="n">DASHBOARD_OUTPUT_PATH</span> <span class="o">/</span> <span class="n">COUNTRY</span> <span class="o">/</span> <span class="s2">&quot;priority_change.csv&quot;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">province_assess_df</span> <span class="o">=</span> <span class="n">province_assess_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">ProvinceAssessDF</span><span class="o">.</span><span class="n">time</span><span class="p">])</span>
    <span class="n">province_assess_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="n">DASHBOARD_OUTPUT_PATH</span> <span class="o">/</span> <span class="n">COUNTRY</span> <span class="o">/</span> <span class="s2">&quot;province_assess.csv&quot;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">dec_wh_stock_assess</span> <span class="o">=</span> <span class="n">wh_stock_assess</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">ItemProvinceAssessDF</span><span class="o">.</span><span class="n">time_hms</span><span class="p">])</span>
    <span class="n">dec_wh_stock_assess</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="n">DASHBOARD_OUTPUT_PATH</span> <span class="o">/</span> <span class="n">COUNTRY</span> <span class="o">/</span> <span class="s2">&quot;wh_stock_assess_as_decimal.csv&quot;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">wh_stock_assess</span> <span class="o">=</span> <span class="n">wh_stock_assess</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">ItemProvinceAssessDF</span><span class="o">.</span><span class="n">time_hms</span><span class="p">])</span>
    <span class="n">wh_stock_assess</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="n">DASHBOARD_OUTPUT_PATH</span> <span class="o">/</span> <span class="n">COUNTRY</span> <span class="o">/</span> <span class="s2">&quot;wh_stock_assess.csv&quot;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">reallocation_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="n">DASHBOARD_OUTPUT_PATH</span> <span class="o">/</span> <span class="n">COUNTRY</span> <span class="o">/</span> <span class="s2">&quot;reallocation.csv&quot;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">single_warehouse_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="n">DASHBOARD_OUTPUT_PATH</span> <span class="o">/</span> <span class="n">COUNTRY</span> <span class="o">/</span> <span class="s2">&quot;single_warehouse.csv&quot;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">dis_totals_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
        <span class="n">DASHBOARD_OUTPUT_PATH</span> <span class="o">/</span> <span class="n">COUNTRY</span> <span class="o">/</span> <span class="s2">&quot;disaster_totals.csv&quot;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="disaster_prepositioning_3_B.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">3.B More On Expected Value</p>
      </div>
    </a>
    <a class="right-next"
       href="disaster_prepositioning_5.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Wrapping It Up</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-reader-and-class">Data Reader and Class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis">Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#geting-it-ready-for-optimization">Geting it ready for Optimization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solver">Solver</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#runing-it-all">Runing it All</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Gurobi Optimization
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Gurobi Optimization, LLC.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>